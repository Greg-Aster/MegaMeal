---
import MainGridLayout from '../layouts/MainGridLayout.astro';
import { getEntry, getCollection } from 'astro:content';
import { i18n } from '../i18n/translation';
import I18nKey from '../i18n/i18nKey';
import Markdown from '@components/misc/Markdown.astro';
import { Icon } from 'astro-icon/components';
import { collections } from '../content/config';
import TOC from '@components/widget/TOC.astro';
import { aboutConfig } from '../config/about.config';

// Fetch the about content
const aboutPost = await getEntry('spec', 'about');
if (!aboutPost) {
  throw new Error("About content not found in 'spec/about'");
}
const { Content, headings: aboutHeadings } = await aboutPost.render();

// Fetch team members
const allTeamMembers = await getCollection('team');
const teamMembers = allTeamMembers.sort((a, b) => a.data.order - b.data.order);

const processedTeamMembers = await Promise.all(
  teamMembers.map(async (member) => {
    const { Content: MemberContent } = await member.render();
    return {
      ...member.data,
      slug: member.slug,
      contentId: `member-content-${member.slug}`
    };
  })
);

// Helper function to get avatar shape class
function getAvatarShapeClass(shape: 'circle' | 'rounded' | 'square' | string) {
  switch(shape) {
    case 'circle':
      return 'rounded-full';
    case 'rounded':
      return 'rounded-lg';
    case 'square':
    default:
      return '';
  }
}
---

<MainGridLayout 
  title={i18n(I18nKey.about)} 
  description="Explore the Mega Meal Saga Universe: A sprawling world of dystopian fast-food, cosmic entities, and surreal narratives. Learn about its creation and lore."
  headings={aboutConfig.content.showTableOfContents ? aboutHeadings : undefined}
>
  
  <!-- Individual Authors Section - NEW -->
  <div id="authors-section" class="card-base flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32 mb-4">
    <div class="pl-6 md:pl-9 pr-6 md:pr-9 pt-6 md:pt-7 pb-6 w-full">
      <h2 class="text-2xl font-bold text-90 mb-4 text-[var(--primary)] dark:text-[var(--primary)]">Featured Authors</h2>
      <p class="text-neutral-600 dark:text-neutral-300 mb-4">
        Meet the creative minds behind the MEGAMEAL Universe and other content on this site.
      </p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Merkin Author Card -->
        <a href="/about/merkin/" class="author-card group rounded-lg overflow-hidden transition-all hover:shadow-lg bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 border border-purple-200 dark:border-purple-700 hover:border-purple-300 dark:hover:border-purple-600">
          <div class="p-6 flex items-center gap-4">
            <img src="/posts/timeline/merkin.png" alt="Merkin Lord of Love and Light" class="w-16 h-16 object-cover rounded-lg flex-shrink-0" />
            <div class="flex-1">
              <h3 class="text-lg font-bold text-purple-900 dark:text-purple-100 group-hover:text-purple-700 dark:group-hover:text-purple-200 transition">
                Merkin Lord of Love and Light
              </h3>
              <p class="text-sm text-purple-700 dark:text-purple-300 mb-1">Curator of the MEGAMEAL Universe</p>
              <p class="text-xs text-purple-600 dark:text-purple-400">Timeline chronicler and cosmic guide</p>
            </div>
            <Icon name="material-symbols:arrow-forward-rounded" class="text-purple-600 dark:text-purple-400 group-hover:translate-x-1 transition-transform" />
          </div>
        </a>

        <!-- Gregory Aster Author Card -->
        <a href="/about/gregory-aster/" class="author-card group rounded-lg overflow-hidden transition-all hover:shadow-lg bg-gradient-to-br from-blue-50 to-teal-50 dark:from-blue-900/20 dark:to-teal-900/20 border border-blue-200 dark:border-blue-700 hover:border-blue-300 dark:hover:border-blue-600">
          <div class="p-6 flex items-center gap-4">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-teal-500 rounded-lg flex-shrink-0 flex items-center justify-center">
              <Icon name="material-symbols:movie-rounded" class="text-white text-2xl" />
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold text-blue-900 dark:text-blue-100 group-hover:text-blue-700 dark:group-hover:text-blue-200 transition">
                Gregory Aster
              </h3>
              <p class="text-sm text-blue-700 dark:text-blue-300 mb-1">Creator & Director</p>
              <p class="text-xs text-blue-600 dark:text-blue-400">Experimental videographer and storyteller</p>
            </div>
            <Icon name="material-symbols:arrow-forward-rounded" class="text-blue-600 dark:text-blue-400 group-hover:translate-x-1 transition-transform" />
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Team Section -->
  {aboutConfig.team.enabled && (
    <div id="team-section" class="card-base flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32 mb-4">
      <div class="pl-6 md:pl-9 pr-6 md:pr-9 pt-6 md:pt-7 pb-6 w-full">
        <h2 class="text-2xl font-bold text-90 mb-4 text-[var(--primary)] dark:text-[var(--primary)]">{aboutConfig.team.title}</h2>
        {aboutConfig.team.description && (
          <p class="text-neutral-600 dark:text-neutral-300 mb-4">{aboutConfig.team.description}</p>
        )}
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {processedTeamMembers.map((member, index) => (
            <div class="team-member-card rounded-lg overflow-hidden transition-all hover:shadow-lg cursor-pointer"
                 data-member-slug={member.slug}>
              <img src={member.image} alt={member.name} class={`w-full h-64 object-cover ${getAvatarShapeClass(aboutConfig.team.avatarShape)}`} />
              <div class="p-4">
                <h3 class="text-xl font-bold text-90 mb-4 text-[var(--primary)] dark:text-[var(--primary)]">{member.name}</h3>
                {aboutConfig.team.showRole && member.role && (
                  <p class="text-sm text-neutral-400">{member.role}</p>
                )}
                {aboutConfig.team.showEmail && member.email && (
                  <a href={`mailto:${member.email}`} class="text-[var(--primary)] hover:text-[var(--primary-dark)] block mt-2">{member.email}</a>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  )}

  <!-- Dynamic Content Section (About/Team Member) -->
  {aboutConfig.content.enabled && (
    <div id="dynamic-content-section" class="card-base flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32 mb-4">
      <div class="pl-6 md:pl-9 pr-6 md:pr-9 pt-6 md:pt-7 pb-6 w-full">
        <h2 id="dynamic-section-title" class="text-2xl font-bold text-90 mb-4 text-[var(--primary)] dark:text-[var(--primary)]">{aboutConfig.content.defaultTitle}</h2>
        <div id="about-content" class="mt-2">
          <Markdown class="prose dark:prose-invert">
            <Content />
          </Markdown>
        </div>
        <div id="member-content" class="mt-2 hidden prose dark:prose-invert text-neutral-800 dark:text-neutral-200"></div>
      </div>
    </div>
  )}

  <!-- Hidden divs for each member's content -->
  {teamMembers.map(async (member) => {
    const { Content } = await member.render();
    return (
      <div id={`member-content-${member.slug}`} class="member-content-source prose dark:prose-invert text-neutral-800 dark:text-neutral-200" style="display: none;">
        <Markdown class="prose dark:prose-invert">
          <Content />
        </Markdown>
      </div>
    );
  })}

  <!-- Contact Section -->
  {aboutConfig.contact.enabled && (
    <section class="card-base px-9 py-6 rounded-[var(--radius-large)]">
      <h2 class="text-2xl font-bold text-90 mb-4 text-[var(--primary)] dark:text-[var(--primary)]">{aboutConfig.contact.title}</h2>
      <div class="flex flex-col md:flex-row gap-8">
        <div class="flex-1">
          <p class="text-sm text-neutral-400">Have questions, ideas, or want to collaborate?</p>
          <p class="text-sm text-neutral-400">We'd love to hear from you!</p>
          <p class="text-sm text-neutral-400">Please Email</p>
          <p class="text-sm text-neutral-400">Greg@dndiy.org</p>
        </div>
      </div>
    </section>
  )}
</MainGridLayout>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const teamCards = document.querySelectorAll('.team-member-card');
  const dynamicSectionTitle = document.getElementById('dynamic-section-title');
  const aboutContent = document.getElementById('about-content');
  const memberContent = document.getElementById('member-content');
  
  // Function to show the About Project content
  const showAboutProject = () => {
    if (dynamicSectionTitle) dynamicSectionTitle.textContent = 'About The Project';
    if (aboutContent) aboutContent.classList.remove('hidden');
    if (memberContent) memberContent.classList.add('hidden');
    
    // Remove active state from all cards
    teamCards.forEach(card => {
      card.classList.remove('ring-2', 'ring-[var(--primary)]');
    });
  };
  
  // Initialize with about project content
  showAboutProject();
  
  // Add event listeners to team cards
  teamCards.forEach((card) => {
    card.addEventListener('click', () => {
      const slug = (card as HTMLElement).dataset.memberSlug;
      if (!slug) return;
      
      // Update the section title with member name
      const memberName = card.querySelector('h3')?.textContent || 'Team Member';
      if (dynamicSectionTitle) dynamicSectionTitle.textContent = memberName;
      
      // Hide about content, show member content
      if (aboutContent) aboutContent.classList.add('hidden');
      if (memberContent) {
        memberContent.classList.remove('hidden');
        
        // Get content from the hidden div and inject it
        const contentElement = document.getElementById(`member-content-${slug}`);
        
        if (contentElement && memberContent) {
          memberContent.innerHTML = contentElement.innerHTML;
        }
        
        // Smooth scroll to content section
        document.getElementById('dynamic-content-section')?.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'nearest' 
        });
      }
      
      // Add active state to the clicked card, remove from others
      teamCards.forEach(c => {
        c.classList.remove('ring-2', 'ring-[var(--primary)]');
      });
      card.classList.add('ring-2', 'ring-[var(--primary)]');
    });
  });
});
</script>