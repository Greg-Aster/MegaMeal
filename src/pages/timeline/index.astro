---
// src/pages/timeline/index.astro
import MainGridLayout from '../../layouts/MainGridLayout.astro';
import { siteConfig } from '../../config';
import TimelineController from '../../components/timeline/TimelineController.astro';
import TimelineNavigation from '../../components/timeline/TimelineNavigation.astro';
import TimelineWidget from '../../components/timeline/TimelineWidget.astro';
import WidgetLayout from '../../components/widget/WidgetLayout.astro';
import { Icon } from 'astro-icon/components';
import { getTimelineEvents, getTimelineStatistics, defaultEraDisplayNames as eraDisplayNames } from '../../services/TimelineService';

// Get timeline data with our service
const allTimelineEvents = await getTimelineEvents();
const timelineStats = getTimelineStatistics(allTimelineEvents);

// Get URL parameters for category filtering
const { category } = Astro.params;

// Page metadata
const title = category 
  ? `${category.charAt(0).toUpperCase() + category.slice(1).replace(/-/g, ' ')} Timeline` 
  : "Universe Timeline";
const description = category
  ? `Explore the chronology of ${category.replace(/-/g, ' ')} events across the universe timeline.`
  : "Explore the chronology of events across the universe timeline.";
---

<MainGridLayout title={title} description={description}>
  <div class="card-base p-8 mb-6">
    <h1 class="text-3xl font-bold mb-4 text-90">{title}</h1>
    <p class="text-75 mb-6">{description}</p>
    
    <div class="timeline-stats grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="stat-card p-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[oklch(0.25_0.025_var(--hue))] rounded-lg">
        <div class="text-[var(--primary)] text-2xl font-bold">{timelineStats.totalEvents}</div>
        <div class="text-50">Timeline Events</div>
      </div>
      
      <div class="stat-card p-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[oklch(0.25_0.025_var(--hue))] rounded-lg">
        <div class="text-[var(--primary)] text-2xl font-bold">{timelineStats.keyEvents}</div>
        <div class="text-50">Key Events</div>
      </div>
      
      <div class="stat-card p-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[oklch(0.25_0.025_var(--hue))] rounded-lg">
        <div class="text-[var(--primary)] text-2xl font-bold">{timelineStats.eras.length}</div>
        <div class="text-50">Historical Eras</div>
      </div>
      
      <div class="stat-card p-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[oklch(0.25_0.025_var(--hue))] rounded-lg">
        <div class="text-[var(--primary)] text-2xl font-bold">{timelineStats.yearSpan}</div>
        <div class="text-50">Year Span</div>
      </div>
    </div>
    
    <TimelineController 
      title={title}
      category={category} 
      isCollapsed={false}
      compact={false}
    />
  </div>
  
  {!category && (
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      {timelineStats.categories.map(cat => (
        <div class="card-base p-4">
          <h2 class="font-bold text-xl mb-2 text-75">{cat} Timeline</h2>
          <p class="text-50 text-sm mb-3">Events related to the {cat} storyline.</p>
          <TimelineWidget 
            title=""
            category={cat}
            count={3}
            isCollapsed={false}
            collapsedHeight="120px"
          />
          <div class="flex justify-end mt-3">
            <a href={`/timeline/${cat ? cat.toLowerCase().replace(/\s+/g, '-') : ''}`} class="btn-regular rounded-md px-3 py-1 text-sm">
              View Category Timeline
            </a>
          </div>
        </div>
      ))}
    </div>
  )}
  
  <WidgetLayout id="timeline-browser" name="Timeline Browser" class="mb-6">
    <div class="timeline-browse-tabs mb-4">
      <div class="flex border-b border-[var(--line-divider)]">
        <button id="list-tab" class="timeline-tab px-4 py-2 border-b-2 border-[var(--primary)] font-bold text-75">
          List View
        </button>
        <button id="tree-tab" class="timeline-tab px-4 py-2 border-b-2 border-transparent text-50">
          Tree View
        </button>
        <button id="map-tab" class="timeline-tab px-4 py-2 border-b-2 border-transparent text-50">
          Map View
        </button>
      </div>
    </div>
    
    <TimelineNavigation view="list" category={category} showCard={false} />
  </div>
  
  {!category && (
    <div class="card-base p-6 mb-6">
      <h2 class="font-bold text-xl mb-4 text-75">Historical Eras</h2>
      <div class="eras-grid grid grid-cols-1 md:grid-cols-2 gap-4">
        {Object.entries(eraDisplayNames).map(([eraKey, eraName]) => (
          <div class={`era-card p-4 bg-[oklch(0.8_0.1_var(--hue))/0.1] dark:bg-[oklch(0.8_0.1_var(--hue))/0.2] rounded-lg era-${eraKey}`}>
            <h3 class="font-bold text-lg text-[oklch(0.3_0.1_var(--hue))] dark:text-[oklch(0.8_0.1_var(--hue))]">{eraName}</h3>
            <p class="text-50 text-sm">
              {eraKey === 'pre-spork' && 'The time before utensils gained sentience. A period of peace and advancement.'}
              {eraKey === 'spork-uprising' && 'The rebellion of sentient utensils that changed society forever.'}
              {eraKey === 'snuggaloid' && 'When mysterious interdimensional beings known as Snuggaloids first appeared.'}
              {eraKey === 'post-extinction' && 'The rebuilding period after the near-extinction of the native species.'}
            </p>
          </div>
        ))}
      </div>
    </div>
  )}
  
  <div class="card-base p-6">
    <h2 class="font-bold text-xl mb-4 text-75">About the Timeline</h2>
    <div class="text-50">
      <p class="mb-4">This timeline chronicles events across the universe, drawing from various documented sources and historical records.</p>
      
      <h3 class="font-bold text-lg mb-2 text-75">Adding to the Timeline</h3>
      <p class="mb-2">To add events to this timeline, include the following properties in your post frontmatter:</p>
      
      <div class="bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[oklch(0.25_0.025_var(--hue))] p-4 rounded-lg mb-4 font-mono text-sm">
        <pre>---
title: "Event Title"
timelineYear: 3042
timelineEra: "spork-uprising"  # Optional
timelineLocation: "Location"   # Optional
isKeyEvent: true              # Optional
---</pre>
      </div>
      
      <p>Timeline events are automatically collected from posts with the timelineYear property and displayed in chronological order.</p>
    </div>
  </div>
</MainGridLayout>

<script>
  // Tab switching logic for timeline view
  const initTimelineTabs = () => {
    const tabs = document.querySelectorAll('.timeline-tab');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Update tab appearance
        tabs.forEach(t => {
          t.classList.remove('border-[var(--primary)]', 'font-bold', 'text-75');
          t.classList.add('border-transparent', 'text-50');
        });
        
        tab.classList.add('border-[var(--primary)]', 'font-bold', 'text-75');
        tab.classList.remove('border-transparent', 'text-50');
        
        // Update view
        const viewType = tab.id.replace('-tab', '');
        
        // Find the timeline-navigation custom element
        const navigation = document.querySelector('timeline-navigation');
        if (navigation) {
          // Find the specific view button within the navigation
          const viewBtn = navigation.querySelector(`.timeline-view-btn[data-view="${viewType}"]`);
          if (viewBtn) {
            (viewBtn as HTMLElement).click();
          }
        }
      });
    });
  };

  // Initialize on load and for Astro View Transitions
  document.addEventListener('DOMContentLoaded', initTimelineTabs);
  document.addEventListener('astro:page-load', initTimelineTabs);
</script>

<style>
  /* Era card styles with unique colors per era */
  .era-pre-spork {
    background-color: oklch(0.8 0.1 var(--hue) / 0.1);
  }
  
  .era-spork-uprising {
    background-color: oklch(0.7 0.2 var(--hue) / 0.1);
  }
  
  .era-snuggaloid {
    background-color: oklch(0.6 0.3 var(--hue) / 0.1);
  }
  
  .era-post-extinction {
    background-color: oklch(0.5 0.1 var(--hue) / 0.1);
  }
  
  .dark .era-pre-spork {
    background-color: oklch(0.8 0.1 var(--hue) / 0.2);
  }
  
  .dark .era-spork-uprising {
    background-color: oklch(0.7 0.2 var(--hue) / 0.2);
  }
  
  .dark .era-snuggaloid {
    background-color: oklch(0.6 0.3 var(--hue) / 0.2);
  }
  
  .dark .era-post-extinction {
    background-color: oklch(0.5 0.1 var(--hue) / 0.2);
  }
  
  /* Animation for the stats cards */
  .stat-card {
    transition: all 0.3s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
</style>