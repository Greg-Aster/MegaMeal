---
import { Icon } from 'astro-icon/components';
import { getTimelineEvents } from '../../services/TimelineService';
import { getPostUrlBySlug } from '../../utils/url-utils';
import WidgetLayout from '../widget/WidgetLayout.astro';
import '../../styles/timeline.css'; // Add this import


interface Props {
  title?: string;
  category?: string;
  count?: number;
  showOnlyKey?: boolean;
  class?: string;
  isCollapsed?: boolean;
  collapsedHeight?: string;
}

const {
  title = "Recent Timeline Events",
  category = "",
  count = 5,
  showOnlyKey = false,
  class: className = "",
  isCollapsed = false,
  collapsedHeight = "180px"
} = Astro.props;

// Get posts with timeline data using the TimelineService directly
const timelineEvents = await getTimelineEvents({
  category,
  onlyKeyEvents: showOnlyKey
});

// Sort by year (newest first) and limit to count
const sortedEvents = [...timelineEvents]
  .sort((a, b) => b.year - a.year)
  .slice(0, count);
---

<WidgetLayout id="timeline-widget" name={title} class={className} isCollapsed={isCollapsed} collapsedHeight={collapsedHeight}>
  {sortedEvents.length > 0 ? (
    <div class="timeline-widget-list">
      {sortedEvents.map((event) => (
        <a href={getPostUrlBySlug(event.slug)} class="timeline-widget-event flex hover:bg-[var(--btn-card-bg-hover)] rounded-md p-2 mb-2 transition-colors">
          <div class="event-year px-2 py-1 text-xs font-bold rounded-md text-white bg-[var(--primary)] flex items-center justify-center mr-2">
            {event.year}
          </div>
          <div class="event-content flex-1">
            <div class="event-title font-bold text-75 text-sm">{event.title}</div>
            <div class="event-description text-50 text-xs truncate">{event.description}</div>
          </div>
          {event.isKeyEvent && (
            <div class="event-key-indicator flex items-center ml-2">
              <Icon name="material-symbols:star" class="text-[var(--primary)] w-4 h-4" />
            </div>
          )}
        </a>
      ))}
      
      <a href="/timeline" class="btn-plain w-full text-center py-2 mt-2 rounded-md">
        View Full Timeline
      </a>
    </div>
  ) : (
    <div class="text-center py-4">
      <div class="text-50">No timeline events found</div>
    </div>
  )}
</WidgetLayout>

