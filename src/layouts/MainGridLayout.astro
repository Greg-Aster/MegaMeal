---
// =====================================================================
// COMPONENT IMPORTS - CLEAN AND SIMPLE
// =====================================================================
import Footer from '@components/Footer.astro'
import Navbar from '@components/Navbar.astro'
import BackToTop from '@components/control/BackToTop.astro'
import SideBar from '@components/widget/SideBar.astro'
import Layout from './Layout.astro'
import { Icon } from 'astro-icon/components'
import { siteConfig } from '../config/config'
import type { MarkdownHeading } from 'astro'
import TOC from "../components/widget/TOC.astro";
import ImageWrapper from "../components/misc/ImageWrapper.astro";
import { Image } from 'astro:assets';
import TimelineController from '../components/timeline/TimelineBanner.astro';
import '../styles/timeline-styles.css';
import '../styles/banner-styles.css';

// Bleepy (AI Assistant) related imports
import Bleepy from '@components/bleepy/Bleepy.astro';
import BleepyBanner from '@components/bleepy/BleepyBanner.astro';

// Banner configuration - ONLY import what works in Astro frontmatter
import {
  bannerConfig,
  determineBannerConfiguration,
  getFallbackBannerCSS,
  getBannerAnimationSettings,
  getBannerLink,
  getPageSpecificOverlap
} from '../config/banner.config';

// =====================================================================
// TYPESCRIPT INTERFACES
// =====================================================================

interface Props {
  title?: string
  banner?: string              
  description?: string
  lang?: string
  setOGTypeArticle?: boolean
  headings?: MarkdownHeading[] 
  post?: any                   
  bannerLink?: string          
  isPostPage?: boolean         
  pageMascotContext?: string;  
  backgroundImage?: string | null; 
}

// =====================================================================
// PROPS DESTRUCTURING AND SETUP
// =====================================================================

const { 
  title, 
  banner = siteConfig.banner.src,
  description, 
  lang, 
  setOGTypeArticle, 
  headings = [], 
  post,
  bannerLink = '',
  isPostPage = false,
  backgroundImage 
} = Astro.props

// =====================================================================
// DYNAMIC BACKGROUND IMAGE LOGIC
// =====================================================================

const getDynamicBackgroundImage = () => {
  if (backgroundImage === "none" || backgroundImage === "") {
    return null;
  }
  if (backgroundImage) {
    return backgroundImage;
  }
  if (siteConfig.banner.enable && siteConfig.banner.src) {
    return siteConfig.banner.src;
  }
  return null;
};

const currentBackgroundImage = getDynamicBackgroundImage();
const shouldShowParallaxBackground = currentBackgroundImage && siteConfig.banner.enable && bannerConfig.parallax.enabled;

// =====================================================================
// BANNER CONFIGURATION PROCESSING
// =====================================================================

// Determine current page type
let currentPageType = 'default';
const currentPath = Astro.url.pathname;

if (currentPath === '/' || currentPath === '/home/') {
  currentPageType = 'home';
} else if (currentPath.startsWith('/posts/') || currentPath.startsWith('/blog/')) {
  currentPageType = 'post';
} else if (currentPath.startsWith('/archive/') || currentPath.startsWith('/categories/') || currentPath.startsWith('/tags/')) {
  currentPageType = 'archive';
} else if (currentPath.startsWith('/about/')) {
  currentPageType = 'about';
}

// Get banner configuration
const bannerConfiguration = determineBannerConfiguration(post, currentPageType, bannerLink);

// Destructure the configuration
const {
  postData,
  bannerType,
  bannerDataSources,
  layout,
  finalBannerLink,
  currentBannerType
} = bannerConfiguration;

// Destructure banner type flags
const {
  hasTimelineBanner,
  hasVideoBanner,
  hasImageBanner,
  hasAssistantBanner,
  hasStandardBanner,
  hasPostBanner,
  isStandardPage
} = bannerType;

// Destructure layout values - SIMPLIFIED
const {
  mainPanelTop,
  navbarSpacing,
  bannerHeight: BANNER_HEIGHT,
  bannerOverlap: BANNER_OVERLAP,
  mainContentOffset,
  dynamicOverlap
} = layout;

// =====================================================================
// BLEEPY CONTEXT SETUP
// =====================================================================

let contextForBleepy = null;
if (post && post.data) {
  contextForBleepy = {
    title: post.data.title,
    description: post.data.description,
    tags: post.data.tags,
    category: post.data.category,
    timelineEra: post.data.timelineEra,
    timelineLocation: post.data.timelineLocation,
    mascotContext: post.data.mascotContext,
  };
}
---

<Layout 
  title={title} 
  banner={banner} 
  description={description} 
  lang={lang} 
  setOGTypeArticle={setOGTypeArticle}
  post={post} 
>

  <!-- =============================================================== -->
  <!-- PARALLAX BACKGROUND SECTION                                   -->
  <!-- =============================================================== -->
  {shouldShowParallaxBackground && 
    <div id="parallax-banner" class="fixed top-0 left-0 w-full h-screen z-[-1] overflow-hidden">
      <ImageWrapper 
        id="parallax-image" 
        alt="Site background image" 
        class="parallax-bg object-cover w-full h-[120vh]"
        src={currentBackgroundImage} 
        position={siteConfig.banner.position || 'center'}
      />
      {siteConfig.banner.credit?.enable && 
        <div class="absolute bottom-4 right-4 text-white/50 text-xs bg-black/30 px-2 py-1 rounded">
          {siteConfig.banner.credit.text && 
            <a href={siteConfig.banner.credit.url || '#'} class="hover:text-white/80 transition">
              {siteConfig.banner.credit.text}
            </a>
          }
        </div>
      }
      <div class="absolute inset-0 bg-gradient-to-b from-black/20 to-black/50 pointer-events-none"></div>
    </div>
  }

  <!-- =============================================================== -->
  <!-- NAVIGATION BAR SECTION                                        -->
  <!-- =============================================================== -->
  <slot slot="head" name="head"></slot>
  <div id="top-row" class="z-50 pointer-events-none relative transition-all duration-700 max-w-[var(--page-width)] px-2 md:px-4 mx-auto">
    <div id="navbar-wrapper" class="pointer-events-auto sticky top-0 transition-all">
      <Navbar></Navbar>
    </div>
  </div>

  <!-- =============================================================== -->
  <!-- UNIFIED BANNER CONTAINER - PROPER HIERARCHY                   -->
  <!-- =============================================================== -->
  <div id="banner-container" 
    class={`z-10 w-full relative transition-all duration-500
      ${hasTimelineBanner ? 'has-timeline-banner' : ''}
      ${hasVideoBanner ? 'has-video-banner' : ''}
      ${hasImageBanner ? 'has-image-banner' : ''}
      ${hasAssistantBanner ? 'has-assistant-banner' : ''}
      ${hasStandardBanner ? 'has-standard-banner' : ''}`}
    style={`margin-top: ${navbarSpacing};`}
  >

    <!-- VIDEO BANNER -->
    {hasVideoBanner && (
      <div class="banner-container-video">
        <div class="banner-aspect-container">
          <div class="banner-content-wrapper">
            <iframe
              src={`https://www.youtube.com/embed/${hasPostBanner && post?.data?.bannerType === "video" ? post.data.bannerData.videoId : bannerDataSources.videoBannerData?.videoId}?autoplay=0&mute=0&controls=1`}
              title="YouTube video player"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture;"
              allowfullscreen
              class="absolute top-0 left-0 w-full h-full"
            ></iframe>
          </div>
        </div>
      </div>
    )}

    <!-- ASSISTANT BANNER -->
    {hasAssistantBanner && (
      <div class="banner-container-assistant">
        <div class="banner-aspect-container">
          <div class="banner-content-wrapper">
            <BleepyBanner backgroundImageUrl={bannerDataSources.assistantBannerData?.imageUrl} />
          </div>
        </div>
      </div>
    )}

    <!-- TIMELINE BANNER -->
    {hasTimelineBanner && (
      <div class="banner-container-timeline">
        <div class="banner-aspect-container">
          <div class="banner-content-wrapper">
            <TimelineController
              category={hasPostBanner && post?.data?.bannerType === "timeline" ? post.data.bannerData.category : (bannerDataSources.timelineBannerData?.category || "MEGA MEAL")}
              startYear={hasPostBanner && post?.data?.bannerType === "timeline" ? post.data.bannerData.startYear : bannerDataSources.timelineBannerData?.startYear}
              endYear={hasPostBanner && post?.data?.bannerType === "timeline" ? post.data.bannerData.endYear : bannerDataSources.timelineBannerData?.endYear}
              background={hasPostBanner && post?.data?.bannerType === "timeline" ? (post.data.bannerData.background || "/posts/timeline/universe.png") : (bannerDataSources.timelineBannerData?.background || "/posts/timeline/universe.png")}
              compact={hasPostBanner && post?.data?.bannerType === "timeline" ? (post.data.bannerData.compact || false) : (bannerDataSources.timelineBannerData?.compact || false)}
              class="w-full h-full"
              asBanner={true}
              bannerHeight="100%"
            />
          </div>
        </div>
      </div>
    )}

    <!-- IMAGE BANNER -->
    {hasImageBanner && (
      <div class="banner-container-image">
        <div class="banner-aspect-container">
          <div class="banner-content-wrapper">
            {finalBannerLink ? (
              <a 
                href={finalBannerLink} 
                aria-label="Banner Link" 
                class="group block w-full h-full"
              >
                <div class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50 w-full h-full z-50 flex items-center justify-center">
                  <Icon
                    name="fa6-solid:link"
                    class="text-white drop-shadow-lg"
                    style="font-size: clamp(2rem, 4vw, 4rem);"
                  ></Icon>
                </div>
                <img
                  src={hasPostBanner && post?.data?.bannerType === "image" ? (post.data.bannerData?.imageUrl || post.data.image) : (bannerDataSources.imageBannerData?.imageUrl || siteConfig.banner.src)}
                  alt={hasPostBanner ? (post.data.title || "Post banner image") : (title || "Banner image")}
                  class="w-full h-full object-cover"
                />
              </a>
            ) : (
              <img
                src={hasPostBanner && post?.data?.bannerType === "image" ? (post.data.bannerData?.imageUrl || post.data.image) : (bannerDataSources.imageBannerData?.imageUrl || siteConfig.banner.src)}
                alt={hasPostBanner ? (post.data.title || "Post banner image") : (title || "Banner image")}
                class="w-full h-full object-cover"
              />
            )}
          </div>
        </div>
      </div>
    )}

    <!-- STANDARD BANNER - FIXED HIERARCHY -->
    {hasStandardBanner && (
      <div class="banner-container-standard">
        <div class="banner-aspect-container">
          <div class="banner-content-wrapper">
            <div id="standard-banner-container">
              {bannerConfig.standardBannerConfig.bannerList.length > 0 ? bannerConfig.standardBannerConfig.bannerList.map((item, index) => {
                const bannerLink = getBannerLink(index);
                const isClickable = bannerLink !== null;
                const isVideoItem = bannerConfig.standardBannerConfig.isVideoBannerItem(item);
                const isImageItem = bannerConfig.standardBannerConfig.isImageBannerItem(item);
                
                return (
                  <div 
                    class="banner-slide absolute inset-0 w-full h-full transition-opacity"
                    style={`
                      transition-duration: ${bannerConfig.standardBannerConfig.animation.transitionDuration}ms;
                      opacity: ${index === 0 ? '1' : '0'};
                    `}
                    data-banner-index={index}
                  >
                    <div
                      class="banner-link group w-full h-full relative cursor-pointer"
                      data-has-link={isClickable}
                      data-href={bannerLink}
                      aria-label={`Banner ${index + 1}${isClickable ? ' - Click to visit link' : ' - Click for information'}`}
                      role="button"
                      tabindex="0"
                    >
                      <div class="absolute inset-0 w-full h-full transition-all duration-300 opacity-0 group-hover:opacity-30 bg-black pointer-events-none z-10"></div>
                      
                      <div class="absolute inset-0 w-full h-full flex items-center justify-center transition-all duration-300 opacity-0 group-hover:opacity-100 z-20 pointer-events-none">
                        <Icon
                          name="fa6-solid:circle-info"
                          class="text-white drop-shadow-lg"
                          style="font-size: clamp(2rem, 4vw, 4rem);"
                        />
                      </div>
                      
                      {isVideoItem ? (
                        <>
                          <video
                            src={item.src}
                            autoplay={bannerConfig.standardBannerConfig.video.autoplay}
                            muted={bannerConfig.standardBannerConfig.video.muted}
                            loop={bannerConfig.standardBannerConfig.video.loop}
                            playsinline={bannerConfig.standardBannerConfig.video.playsInline}
                            controls={bannerConfig.standardBannerConfig.video.controls}
                            preload={item.preload || bannerConfig.standardBannerConfig.video.preload}
                            class={`banner-video w-full h-full object-${bannerConfig.visual.objectFit} object-${bannerConfig.visual.objectPosition} transition-transform duration-300 group-hover:scale-105`}
                            style={`border-radius: ${bannerConfig.visual.borderRadius};`}
                            onerror="this.style.display='none'; var ne = this.nextElementSibling; if (ne) ne.style.display='block';"
                          >
                            Your browser does not support the video tag.
                          </video>
                          <Image
                            src={item.fallbackImage}
                            alt={item.alt}
                            width={bannerConfig.layout.maxWidth}
                            height={Math.round(bannerConfig.layout.maxWidth * 0.5625)}
                            class={`banner-image-fallback w-full h-full object-${bannerConfig.visual.objectFit} object-${bannerConfig.visual.objectPosition} transition-transform duration-300 group-hover:scale-105`}
                            style={`border-radius: ${bannerConfig.visual.borderRadius}; display: none;`}
                            loading="lazy"
                          />
                        </>
                      ) : isImageItem ? (
                        <Image
                          src={item.src}
                          alt={item.alt}
                          width={bannerConfig.layout.maxWidth}
                          height={Math.round(bannerConfig.layout.maxWidth * 0.5625)}
                          class={`banner-image w-full h-full object-${bannerConfig.visual.objectFit} object-${bannerConfig.visual.objectPosition} transition-transform duration-300 group-hover:scale-105`}
                          style={`border-radius: ${bannerConfig.visual.borderRadius};`}
                          loading={index === 0 ? 'eager' : 'lazy'}
                        />
                      ) : null}
                    </div>
                  </div>
                );
              }) : (
                <div class="w-full h-full rounded-lg" style={`background: ${getFallbackBannerCSS()};`}></div>
              )}
              
              {bannerConfig.visual.applyGradientOverlay && (
                <div class="absolute inset-0 w-full h-full pointer-events-none" style={`background: ${bannerConfig.visual.gradientOverlay}; border-radius: ${bannerConfig.visual.borderRadius};`}></div>
              )}
            </div>
          </div>
        </div>
      </div>
    )}
  </div>

  <!-- =============================================================== -->
  <!-- MAIN CONTENT WRAPPER                                           -->
  <!-- =============================================================== -->
  <div class={`w-full z-30 pointer-events-none relative`}>
    <div id="main-panel-wrapper" class="relative max-w-[var(--page-width)] mx-auto pointer-events-auto" style={`top: ${mainPanelTop}; position: relative;`}>
      <div id="main-grid" class="transition duration-700 w-full left-0 right-0 grid grid-cols-[5rem_1fr] md:grid-cols-[12rem_1fr] lg:grid-cols-[17.5rem_auto] grid-rows-[auto_1fr_auto] lg:grid-rows-[auto]
         mx-auto gap-2 sm:gap-3 md:gap-4 px-2 md:px-4" style={`margin-top: ${mainContentOffset};`}>
         
        <!-- SIDEBAR SECTION -->
        <SideBar 
          class="mb-4 col-span-1 lg:max-w-[17.5rem] onload-animation" 
          headings={headings}
          postSlug={postData?.slug || ''}
          customAvatar={postData?.customAvatar || ''}
          customName={postData?.customName || ''}
          customBio={postData?.customBio || ''}
          pageMascotContext={Astro.props.pageMascotContext}
        ></SideBar>
        
        <!-- MAIN CONTENT SECTION -->
        <main id="main" class="transition-swup-fade col-span-1 overflow-hidden">
          <div id="main-content-wrapper" class="onload-animation">
            <slot></slot>
            <div class="footer onload-animation hidden lg:block">
              <Footer></Footer>
            </div>
          </div>
        </main>
        
        <!-- Footer for mobile screens - spans both columns -->
        <div class="footer col-span-2 onload-animation block lg:hidden">
          <Footer></Footer>
        </div>
          <Footer></Footer>
        </div>
      </div>

      <BackToTop></BackToTop>
    </div>
  </div>

  <!-- =============================================================== -->
  <!-- TABLE OF CONTENTS SECTION                                      -->
  <!-- =============================================================== -->
  <div class="absolute w-full z-0 hidden 2xl:block">
    <div class="relative max-w-[var(--page-width)] mx-auto">
      {siteConfig.toc.enable && <div id="toc-wrapper" class="hidden lg:block transition absolute top-0 -right-[var(--toc-width)] w-[var(--toc-width)] flex items-center toc-animated">
        <div id="toc-inner-wrapper" class="fixed top-14 w-[var(--toc-width)] h-[calc(100vh_-_20rem)] overflow-y-scroll overflow-x-hidden hide-scrollbar">
          <div id="toc" class="w-full h-full transition-swup-fade ">
            <div class="h-8 w-full"></div>
            <TOC headings={headings}></TOC>
            <div class="h-8 w-full"></div>
          </div>
        </div>
      </div>}

      {!siteConfig.toc.enable && <div id="toc"></div>}
    </div>
  </div>

  <!-- =============================================================== -->
  <!-- BLEEPY INTEGRATION                                             -->
  <!-- =============================================================== -->
  {contextForBleepy && (
    <div id="bleepy-page-context" style="display: none;" data-context={JSON.stringify(contextForBleepy)}></div>
  )}
  <Bleepy mascotContext={Astro.props.pageMascotContext} instanceIdentifier="LAYOUT_BLEEPY" />

</Layout>

<!-- =============================================================== -->
<!-- MAIN CONTENT POSITIONING - NO MORE 768PX BREAKPOINT JUMPS     -->
<!-- =============================================================== -->
<style define:vars={{
  'main-content-offset': mainContentOffset,
}}>
  /* Main content positioning */
  #main-grid {
    margin-top: var(--main-content-offset);
  }
</style>

<!-- =============================================================== -->
<!-- JAVASCRIPT - BANNER DIMENSIONS & ANIMATION                     -->
<!-- =============================================================== -->
<script>
  import { createBannerAnimation, VideoLoadingState } from '@/utils/bannerAnimation';
  import {
    getBannerAnimationSettings,
    bannerConfig,
    standardBannerConfig
  } from '../config/banner.config';

  // ⭐ CRITICAL: Function to inject config values into CSS
  function updateBannerDimensions() {
    try {
      const config = bannerConfig?.dimensions;
      if (config) {
        document.documentElement.style.setProperty('--banner-aspect-ratio', config.aspectRatio);
        document.documentElement.style.setProperty('--banner-max-width', config.maxWidth);
        document.documentElement.style.setProperty('--banner-padding', config.padding);
        document.documentElement.style.setProperty('--banner-border-radius', config.borderRadius);
        console.log('Banner dimensions updated from config:', config);
      } else {
        console.warn('Banner config dimensions not available');
      }
    } catch (error) {
      console.error('Failed to set banner dimensions:', error);
    }
  }

  // Initialize everything when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    updateBannerDimensions();        // ⭐ CRITICAL: Set CSS variables first
    initializePageAnimations();
    initializeBannerAnimation();
    initializeParallaxEffect();
    initializeEventListeners();
    initializeSpecialPageFeatures();
  });

  function initializePageAnimations() {
    updateNavbarHeight();
    
    const elements = document.querySelectorAll('.onload-animation');
    elements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add('loaded');
      }, 100 + (index * 50));
    });
    
    const postImage = document.getElementById('post-image');
    if (postImage) {
      setTimeout(() => {
        postImage.classList.remove('opacity-0', 'scale-105');
      }, 100);
    }
  }

  function initializeBannerAnimation() {
    const bannerController = createBannerAnimation({
      containerId: 'standard-banner-container',
      animationConfig: getBannerAnimationSettings(),
      getBannerItemPreviewDetails: standardBannerConfig.getBannerItemPreviewDetails,
      isVideoBannerItem: bannerConfig.standardBannerConfig.isVideoBannerItem,
      isImageBannerItem: bannerConfig.standardBannerConfig.isImageBannerItem
    });

    const initialized = bannerController.initialize();
    
    if (initialized) {
      console.log('Banner animation system initialized successfully');
    } else {
      console.log('Banner animation system initialization skipped (not applicable)');
    }
  }

  function initializeParallaxEffect() {
    const parallaxBanner = document.getElementById('parallax-banner');
    if (!parallaxBanner) return;
    
    const parallaxImage = document.getElementById('parallax-image');
    if (!parallaxImage) return;
    
    const scrollFactor = bannerConfig.parallax.scrollFactor;
    let ticking = false;

    function updateParallax() {
      const scrollY = window.scrollY;
      const offset = scrollY * scrollFactor;
      
      if (parallaxImage) {
        parallaxImage.style.transform = `translate3d(0, ${offset}px, 0)`;
      }
      ticking = false;
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(updateParallax);
        ticking = true;
      }
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        parallaxBanner.classList.add('loaded');
      }, 100);
    });
  }

  function updateNavbarHeight() {
    const navbar = document.getElementById('navbar-wrapper');
    if (navbar) {
      const navbarHeight = navbar.offsetHeight;
      document.documentElement.style.setProperty('--navbar-height', `${navbarHeight}px`);
    }
  }

  function initializeEventListeners() {
    window.addEventListener('scroll', () => {
      const scrollY = window.scrollY;
      const tocWrapper = document.querySelector('#toc-wrapper');
      if (tocWrapper) {
        if (scrollY > 300) {
          tocWrapper.classList.remove('toc-hide');
        } else {
          tocWrapper.classList.add('toc-hide');
        }
      }
    });
    
    window.addEventListener('resize', () => {
      updateNavbarHeight();
    });

    if ((window as any).siteConfig && (window as any).siteConfig.transparency) {
      document.documentElement.style.setProperty('--bg-opacity', (window as any).siteConfig.transparency);
    }
  }

  function initializeSpecialPageFeatures() {
    const currentPath = window.location.pathname;
    const isCookbookPage = currentPath.includes('cookbook');
    const isFirstContactPage = currentPath.includes('first-contact');
    const isSpecialPage = isCookbookPage || isFirstContactPage;
    
    if (!isSpecialPage) {
      restoreNormalState();
      return;
    }
    
    const pageType = isCookbookPage ? 'cookbook' : 'first-contact';
    console.log(`${pageType} page detected, enabling fullscreen features`);
    
    if (!localStorage.getItem('specialPageOriginalState')) {
      const originalState = localStorage.getItem('fullscreenMode') === 'true';
      localStorage.setItem('specialPageOriginalState', originalState.toString());
      console.log('Saved original fullscreen state:', originalState);
    }
    
    localStorage.setItem('fullscreenMode', 'true');
    localStorage.setItem('fullscreenBannerOverride', 'true');
    document.body.classList.add('force-mobile-view');
    
    if (isCookbookPage) {
      initializeViewToggle();
    }
  }

  function restoreNormalState() {
    const originalState = localStorage.getItem('specialPageOriginalState');
    
    if (originalState !== null) {
      const wasOriginallyFullscreen = originalState === 'true';
      
      if (!wasOriginallyFullscreen) {
        localStorage.setItem('fullscreenMode', 'false');
        localStorage.removeItem('fullscreenBannerOverride');
        document.body.classList.remove('force-mobile-view');
        console.log('Restored to non-fullscreen (original state)');
      } else {
        console.log('Keeping fullscreen (was original state)');
      }
    }
  }

  function initializeViewToggle() {
    const galleryBtn = document.getElementById('gallery-view-btn');
    const listBtn = document.getElementById('list-view-btn');
    const galleryView = document.getElementById('gallery-view');
    const listView = document.getElementById('list-view');
    
    if (!galleryBtn || !listBtn || !galleryView || !listView) return;
    
    const savedView = localStorage.getItem('cookbookView') || 'gallery';
    
    if (savedView === 'list') {
      showListView();
    } else {
      showGalleryView();
    }
    
    galleryBtn.addEventListener('click', () => {
      showGalleryView();
      localStorage.setItem('cookbookView', 'gallery');
    });
    
    listBtn.addEventListener('click', () => {
      showListView();
      localStorage.setItem('cookbookView', 'list');
    });
    
    function showGalleryView() {
      galleryView.classList.remove('hidden');
      listView.classList.add('hidden');
      galleryBtn.className = "px-3 py-1 rounded-md text-sm font-medium transition-all duration-200 bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm";
      listBtn.className = "px-3 py-1 rounded-md text-sm font-medium transition-all duration-200 text-gray-600 dark:text-neutral-400 hover:text-gray-900 dark:hover:text-white";
    }
    
    function showListView() {
      galleryView.classList.add('hidden');
      listView.classList.remove('hidden');
      listBtn.className = "px-3 py-1 rounded-md text-sm font-medium transition-all duration-200 bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm";
      galleryBtn.className = "px-3 py-1 rounded-md text-sm font-medium transition-all duration-200 text-gray-600 dark:text-neutral-400 hover:text-gray-900 dark:hover:text-white";
    }
  }

  // TypeScript interfaces for global types
  interface BannerAnimationAPI {
    start: () => void;
    stop: () => void;
    next: () => void;
    pause: (reason?: string) => void;
    resume: (reason?: string) => void;
    navigateToIndex: (index: number) => void;
    navigateToPrevious: () => void;
    navigateToNext: () => void;
    getCurrentIndex: () => number;
    isPaused: () => boolean;
    getTotalSlides: () => number;
    isManuallyNavigating: () => boolean;
    isVideoSlide: (index: number) => boolean;
    getVideoLoadingState: (index: number) => VideoLoadingState;
    getVideoStats: () => {
      totalVideos: number;
      loadedCount: number;
      loadingCount: number;
      errorCount: number;
      unloadedCount: number;
    };
    showPreview: (index: number) => void;
    hidePreview: (index: number) => void;
    hideAllPreviews: () => void;
    getStatus: () => {
      isPaused: boolean;
      pauseReason: string;
      currentIndex: number;
      isAnimating: boolean;
      hasTimeout: boolean;
    };
  }

  declare global {
    interface Window {
      siteConfig?: {
        transparency?: string | number;
      };
      bannerAnimation?: BannerAnimationAPI;
    }
  }

  // Debug helper
  window.resetSpecialPageState = function() {
    localStorage.removeItem('specialPageOriginalState');
    localStorage.removeItem('cookbookView');
    console.log('Special page state reset. Refresh page to test.');
  };
</script>